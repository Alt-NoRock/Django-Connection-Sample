# Django WebSocket アプリケーション ネットワークフロー図

## 🌐 全体アーキテクチャ

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│                 │    │                 │    │                 │
│   インターネット    │    │   Route 53      │    │   CloudFront    │
│                 │    │   (DNS)         │    │   (CDN)         │
│                 │    │                 │    │   [Optional]    │
└─────────┬───────┘    └─────────┬───────┘    └─────────┬───────┘
          │                      │                      │
          │                      │                      │
          └──────────────────────┼──────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────┐
│                        AWS Application Load Balancer            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐  │
│  │   Listener      │  │   Listener      │  │   Target Group  │  │
│  │   Port 80       │  │   Port 443      │  │   django-main   │  │
│  │   HTTP          │  │   HTTPS         │  │   Port 80       │  │
│  │   ↓ Redirect    │  │   ↓ Forward     │  │                 │  │
│  │   to HTTPS      │  │   to TG         │  │   Health: /health/│  │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘  │
└─────────────────┬───────────────────────────────────────────────┘
                  │
                  │ Load Balance
                  ▼
┌─────────────────────────────────────────────────────────────────┐
│                        EC2 Instance(s)                         │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                    Docker Network                           ││
│  │                                                             ││
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐         ││
│  │  │    Nginx    │  │   Django    │  │    Redis    │         ││
│  │  │   Port 80   │  │ + Daphne    │  │  Port 6379  │         ││
│  │  │             │  │  Port 8000  │  │             │         ││
│  │  │  Reverse    │  │             │  │   Channel   │         ││
│  │  │   Proxy     │  │  WebSocket  │  │    Layer    │         ││
│  │  │             │  │   Handler   │  │             │         ││
│  │  └─────────────┘  └─────────────┘  └─────────────┘         ││
│  │           │               │               │                ││
│  │           └───────────────┼───────────────┘                ││
│  │                           │                                ││
│  │  ┌─────────────────────────┴─────────────────────────┐     ││
│  │  │                PostgreSQL                         │     ││
│  │  │                Port 5432                          │     ││
│  │  │              Database Storage                     │     ││
│  │  └───────────────────────────────────────────────────┘     ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

## 🔄 リクエストフロー詳細

### 1. HTTP リクエストフロー

```
[クライアント] → [ALB] → [EC2:Nginx:80] → [Django:8000] → [PostgreSQL:5432]
     │                                                          ↑
     │                                                          │
     └── POST /create/ ──────────────────────────────────────────┘
         (投稿作成)
```

### 2. WebSocket 接続フロー

```
[クライアント] → [ALB] → [EC2:Nginx:80] → [Django:8000] → [Redis:6379]
     │              │         │              │              │
     │              │         │              │              │
     ▼              ▼         ▼              ▼              ▼
   ws://       HTTPS/WSS   HTTP/WS     Daphne ASGI    Channel Layer
 connection   Termination  Upgrade      Consumer       Message Bus
```

### 3. ランダムメッセージ配信フロー

```
[Background Task] → [Redis:6379] → [Django Channels] → [WebSocket] → [クライアント]
       │                 │              │                 │              │
       │                 │              │                 │              │
       ▼                 ▼              ▼                 ▼              ▼
  Timer Task        Channel Layer   Consumer.send    ws.send()     Browser Update
  (5-20秒間隔)      group_send()    to_client()      Message       DOM Update
```

## 🚦 トラフィック分散とルーティング

### ALB リスナールール

```
┌─────────────────────────────────────────────────────────────────┐
│                      ALB Listener Rules                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────┐    ┌─────────────────┐                     │
│  │   Rule #100     │    │   Rule #200     │                     │
│  │   Priority      │    │   Priority      │                     │
│  │                 │    │                 │                     │
│  │  Condition:     │    │  Condition:     │                     │
│  │  - Path: /ws/*  │    │  - Path: /health│                     │
│  │  - Header:      │    │                 │                     │
│  │    Connection   │    │  Action:        │                     │
│  │    = upgrade    │    │  → Health TG    │                     │
│  │                 │    │    Port 8000    │                     │
│  │  Action:        │    │                 │                     │
│  │  → Main TG      │    │                 │                     │
│  │    Port 80      │    │                 │                     │
│  │  (Sticky)       │    │                 │                     │
│  └─────────────────┘    └─────────────────┘                     │
│                                                                 │
│  ┌─────────────────────────────────────────────────────────────┐│
│  │                Default Rule                                 ││
│  │                                                             ││
│  │  All other traffic → Main Target Group (Port 80)           ││
│  │  Static files, Django views, API endpoints                 ││
│  └─────────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────────┘
```

## 📊 ポートとプロトコルマッピング

### 外部→内部ポートマッピング

| サービス | 外部ポート | 内部ポート | プロトコル | 用途 |
|----------|------------|------------|------------|------|
| ALB | 80 | - | HTTP | HTTP→HTTPS リダイレクト |
| ALB | 443 | - | HTTPS/WSS | メイントラフィック |
| Nginx | - | 80 | HTTP/WS | リバースプロキシ |
| Django+Daphne | - | 8000 | HTTP/WS | アプリケーション |
| PostgreSQL | - | 5432 | TCP | データベース |
| Redis | - | 6379 | TCP | キャッシュ/Channel Layer |

### プロトコル変換フロー

```
Client Browser           ALB              Nginx            Django+Daphne
      │                  │                 │                     │
      │ HTTPS/WSS         │ HTTP/WS         │ HTTP/WS             │
      │ Port 443          │ Port 80         │ Port 8000           │
      │                  │                 │                     │
      ├──HTTP Request────►├──HTTP Request──►├──HTTP Request──────►│
      │                  │                 │                     │
      ├──WebSocket───────►├──WebSocket─────►├──WebSocket─────────►│
      │  Upgrade          │  Upgrade        │  Upgrade            │
      │                  │                 │                     │
      │◄─Response────────◄│◄─Response──────◄│◄─Response───────────│
      │                  │                 │                     │
      │◄─WS Message──────◄│◄─WS Message────◄│◄─WS Message─────────│
```

## 🔧 セキュリティとネットワーク設定

### セキュリティグループ設定

```
┌─────────────────────────────────────────────────────────────────┐
│                       Security Groups                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐    ┌─────────────────────┐              │
│  │    ALB Security     │    │   EC2 Security      │              │
│  │      Group          │    │     Group           │              │
│  │                     │    │                     │              │
│  │  Inbound:           │    │  Inbound:           │              │
│  │  - Port 80  (HTTP)  │    │  - Port 80 (from   │              │
│  │    from 0.0.0.0/0   │    │    ALB SG only)     │              │
│  │  - Port 443 (HTTPS) │    │  - Port 8000 (from │              │
│  │    from 0.0.0.0/0   │    │    ALB SG only)     │              │
│  │                     │    │  - Port 22 (SSH)    │              │
│  │  Outbound:          │    │    from Admin IP    │              │
│  │  - All traffic      │    │                     │              │
│  │    to EC2 SG        │    │  Outbound:          │              │
│  │                     │    │  - All traffic      │              │
│  └─────────────────────┘    └─────────────────────┘              │
└─────────────────────────────────────────────────────────────────┘
```

## 📈 スケーリングとロードバランシング

### Auto Scaling フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                    Auto Scaling Group                          │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │
│  │   EC2-1     │  │   EC2-2     │  │   EC2-3     │              │
│  │  (Primary)  │  │  (Scale)    │  │  (Scale)    │              │
│  │             │  │             │  │             │              │
│  │  Target:    │  │  Target:    │  │  Target:    │              │
│  │  Healthy    │  │  Healthy    │  │  Healthy    │              │
│  └─────────────┘  └─────────────┘  └─────────────┘              │
│         │                 │                 │                  │
│         └─────────────────┼─────────────────┘                  │
│                           │                                    │
│  ┌─────────────────────────┴─────────────────────────┐          │
│  │              ALB Target Group                     │          │
│  │                                                   │          │
│  │  Health Check: /health/ every 30s                │          │
│  │  Sticky Sessions: Enabled (WebSocket)            │          │
│  │  Deregistration Delay: 300s                      │          │
│  └───────────────────────────────────────────────────┘          │
└─────────────────────────────────────────────────────────────────┘
```

### WebSocket セッション管理

```
┌─────────────────────────────────────────────────────────────────┐
│                 WebSocket Session Stickiness                   │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  Client A ──────────────────────────┐                          │
│     │                              │                          │
│     │ Initial HTTP Request         │                          │
│     │ (Gets Cookie)               │                          │
│     ▼                              │                          │
│  ┌─────────────┐                   │  ┌─────────────┐          │
│  │   EC2-1     │◄──────────────────┼──│   EC2-2     │          │
│  │             │                   │  │             │          │
│  │  WebSocket  │                   │  │  WebSocket  │          │
│  │  Connection │                   │  │  Connection │          │
│  │  (Sticky)   │                   │  │             │          │
│  └─────────────┘                   │  └─────────────┘          │
│                                    │                          │
│  Client B ─────────────────────────┘                          │
│     │                                                         │
│     │ Different Cookie                                        │
│     ▼                                                         │
│  Routes to available instance                                 │
│                                                               │
└─────────────────────────────────────────────────────────────────┘
```

この図により、Django WebSocketアプリケーションの完全なネットワークフローが理解できるようになりました。ALBを通じたロードバランシング、WebSocketのスティッキーセッション、セキュリティグループの設定、そしてスケーリング戦略まで、すべての要素が連携して動作します。
