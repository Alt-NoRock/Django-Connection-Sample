# Django WebSocket ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

## ğŸ—ï¸ å…¨ä½“ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£å›³

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                    Internet                                 â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                          HTTPS/WSS
                                        (Port 443/80)
                                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                AWS Application Load Balancer (ALB)          â”‚
                    â”‚                                                             â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚  SSL Termination â”‚    â”‚    ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«              â”‚   â”‚
                    â”‚  â”‚  - HTTPS â†’ HTTP â”‚    â”‚  - WebSocket: /ws/*         â”‚   â”‚
                    â”‚  â”‚  - WSS â†’ WS     â”‚    â”‚  - Health: /health/*        â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  - Default: /*              â”‚   â”‚
                    â”‚                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                â”‚
                                        HTTP/WebSocket
                                          (Port 80)
                                                â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                   EC2 Instance                              â”‚
                    â”‚                                                             â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
                    â”‚  â”‚               Docker Environment                    â”‚   â”‚
                    â”‚  â”‚                                                     â”‚   â”‚
                    â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
                    â”‚  â”‚  â”‚  Nginx  â”‚   â”‚  Django+Daphne â”‚   â”‚   Redis   â”‚  â”‚   â”‚
                    â”‚  â”‚  â”‚Port: 80 â”‚â”€â”€â”€â”‚   Port: 8000   â”‚â”€â”€â”€â”‚Port: 6379 â”‚  â”‚   â”‚
                    â”‚  â”‚  â”‚         â”‚   â”‚                â”‚   â”‚           â”‚  â”‚   â”‚
                    â”‚  â”‚  â”‚ Proxy   â”‚   â”‚  ASGI Server   â”‚   â”‚ Channel   â”‚  â”‚   â”‚
                    â”‚  â”‚  â”‚ Static  â”‚   â”‚  WebSocket     â”‚   â”‚ Layer     â”‚  â”‚   â”‚
                    â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  HTTP          â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
                    â”‚  â”‚                â”‚                â”‚                  â”‚   â”‚
                    â”‚  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â”‚
                    â”‚  â”‚                        â”‚                           â”‚   â”‚
                    â”‚  â”‚                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚   â”‚
                    â”‚  â”‚                â”‚  PostgreSQL   â”‚                   â”‚   â”‚
                    â”‚  â”‚                â”‚  Port: 5432   â”‚                   â”‚   â”‚
                    â”‚  â”‚                â”‚               â”‚                   â”‚   â”‚
                    â”‚  â”‚                â”‚   Database    â”‚                   â”‚   â”‚
                    â”‚  â”‚                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â”‚   â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ”— é€šä¿¡ãƒ•ãƒ­ãƒ¼è©³ç´°

### 1. HTTP ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ•ãƒ­ãƒ¼

```
Client Browser
      â”‚
      â”‚ 1. HTTPS Request
      â–¼
Application Load Balancer
      â”‚
      â”‚ 2. HTTP Request (SSLçµ‚ç«¯)
      â–¼
EC2 Instance â†’ Nginx (Port 80)
      â”‚
      â”‚ 3. Proxy Pass
      â–¼
Django + Daphne (Port 8000)
      â”‚
      â”‚ 4. Database Query
      â–¼
PostgreSQL (Port 5432)
```

### 2. WebSocket æ¥ç¶šãƒ•ãƒ­ãƒ¼

```
Client Browser
      â”‚
      â”‚ 1. WSS Connection
      â–¼
Application Load Balancer
      â”‚ Sticky Session æœ‰åŠ¹
      â”‚ 2. WebSocket Upgrade
      â–¼
EC2 Instance â†’ Nginx (Port 80)
      â”‚
      â”‚ 3. WebSocket Proxy
      â–¼
Django + Daphne (Port 8000)
      â”‚
      â”‚ 4. Channel Layer
      â–¼
Redis (Port 6379)
```

## ğŸŒ ãƒãƒ¼ãƒˆæ§‹æˆ

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | å†…éƒ¨ãƒãƒ¼ãƒˆ | å¤–éƒ¨å…¬é–‹ | ç”¨é€” |
|------------|----------|---------|------|
| ALB | - | 80, 443 | ã‚¨ãƒ³ãƒˆãƒªãƒ¼ãƒã‚¤ãƒ³ãƒˆ |
| Nginx | 80 | Ã— | ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚· |
| Django+Daphne | 8000 | Ã— | ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒãƒ¼ |
| PostgreSQL | 5432 | Ã— | ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ |
| Redis | 6379 | Ã— | WebSocketãƒãƒ£ãƒ³ãƒãƒ« |

## ğŸ”’ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—è¨­å®š

### ALB ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
```
Inbound Rules:
- HTTP (80) â† 0.0.0.0/0
- HTTPS (443) â† 0.0.0.0/0

Outbound Rules:
- HTTP (80) â†’ EC2 Security Group
```

### EC2 ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—
```
Inbound Rules:
- HTTP (80) â† ALB Security Group
- SSH (22) â† ç®¡ç†è€…IP/32 (å¿…è¦æ™‚ã®ã¿)

Outbound Rules:
- ALL â†’ 0.0.0.0/0 (å¤–éƒ¨APIã€ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨)
```

## ğŸ“¡ ALB ãƒªã‚¹ãƒŠãƒ¼ãƒ«ãƒ¼ãƒ«

### Priority 100: WebSocket ãƒˆãƒ©ãƒ•ã‚£ãƒƒã‚¯
```yaml
æ¡ä»¶:
  - Path: /ws/*
  - Header: Connection=upgrade
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
  - Target Group: django-websocket-main-tg
  - Sticky Session: æœ‰åŠ¹ (24æ™‚é–“)
```

### Priority 200: ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
```yaml
æ¡ä»¶:
  - Path: /health/*
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
  - Target Group: django-websocket-health-tg
  - Port: 8000 (ç›´æ¥Daphne)
```

### Priority 300: ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ (HTTP)
```yaml
æ¡ä»¶:
  - Default
ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:
  - Target Group: django-websocket-main-tg
  - Port: 80 (NginxçµŒç”±)
```

## ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### æŠ•ç¨¿ä½œæˆæ™‚ã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ›´æ–°

```
User A (Browser)
      â”‚
      â”‚ 1. POST /create/
      â–¼
ALB â†’ Nginx â†’ Django
      â”‚
      â”‚ 2. DB Insert
      â–¼
PostgreSQL
      â”‚
      â”‚ 3. Channel Send
      â–¼
Redis Channel Layer
      â”‚
      â”‚ 4. WebSocket Broadcast
      â–¼
All Connected Clients
(User A, User B, User C...)
```

### ãƒ©ãƒ³ãƒ€ãƒ ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡

```
Background Task (Django)
      â”‚
      â”‚ 1. Generate Random Message
      â”‚    (5-20ç§’é–“éš”)
      â–¼
Redis Channel Layer
      â”‚
      â”‚ 2. Channel Send
      â–¼
WebSocket Consumers
      â”‚
      â”‚ 3. Broadcast to Clients
      â–¼
All Connected Browsers
```

## ğŸš€ ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ§‹æˆ (Auto Scaling)

```
                         Internet
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚      ALB       â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚              â”‚              â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  EC2-1  â”‚   â”‚  EC2-2  â”‚   â”‚  EC2-3  â”‚
         â”‚         â”‚   â”‚         â”‚   â”‚         â”‚
         â”‚ Django  â”‚   â”‚ Django  â”‚   â”‚ Django  â”‚
         â”‚ Redis   â”‚   â”‚ Redis   â”‚   â”‚ Redis   â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚              â”‚              â”‚
              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   RDS (å…±æœ‰)   â”‚
                    â”‚   PostgreSQL   â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ³¨æ„**: Redis ã¯å„EC2ã§å€‹åˆ¥å®Ÿè¡Œã€‚æœ¬æ ¼çš„ãªã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã«ã¯ Redis Cluster ã¾ãŸã¯ ElastiCache ãŒå¿…è¦ã€‚

## ğŸ“Š ç›£è¦–ãƒã‚¤ãƒ³ãƒˆ

### ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- **ALB â†’ EC2**: `/health/` ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ
- **é–“éš”**: 30ç§’
- **ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ**: 5ç§’
- **æ­£å¸¸åˆ¤å®š**: 2å›é€£ç¶šæˆåŠŸ
- **ç•°å¸¸åˆ¤å®š**: 2å›é€£ç¶šå¤±æ•—

### ãƒ¡ãƒˆãƒªã‚¯ã‚¹ç›£è¦–
- **EC2**: CPUä½¿ç”¨ç‡ã€ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
- **ALB**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã€ã‚¨ãƒ©ãƒ¼ç‡
- **WebSocket**: æ¥ç¶šæ•°ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸é…ä¿¡æ•°
- **Redis**: ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ã€æ¥ç¶šæ•°

## ğŸ”§ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«å¯¾å¿œ

| ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
|---------|------|
| `nginx.conf` | ALB â†’ Nginx ãƒ—ãƒ­ã‚­ã‚·è¨­å®š |
| `docker-compose.yml` | ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒ |
| `docker-compose.aws.yml` | AWSæœ¬ç•ªç’°å¢ƒ |
| `alb-target-group.tf` | Terraform ALBè¨­å®š |
| `settings.py` | Django ASGI/Channelè¨­å®š |

ã“ã®æ§‹æˆã«ã‚ˆã‚Šã€HTTP/HTTPS ã®é€šå¸¸ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ WebSocket é€šä¿¡ã®ä¸¡æ–¹ã‚’åŠ¹ç‡çš„ã«å‡¦ç†ã—ã€ALB ã®ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚·ãƒ³ã‚°ã¨ã‚¹ãƒ†ã‚£ãƒƒã‚­ãƒ¼ã‚»ãƒƒã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦é«˜å¯ç”¨æ€§ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚
